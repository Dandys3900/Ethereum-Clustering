<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Ethereum Address Clustering</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <!-- GridJS -->
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet"/>
    <!-- Favicon -->
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">

    <!-- Styles -->
    <style>
      .btn-primary {
        /* Official FIT-blue color */
        background-color: #00ABE3;
        border: none;
      }
    </style>

    <!-- JavaScript -->
    <script>
      function showRangeValue(rangeElement) {
        // Get current value of range and update label
        document.getElementById("refreshLabel").innerText = "Refresh scope: " + rangeElement.value + " %";
      }

      function showMenu() {
        const form = document.getElementById("refreshForm");
        form.style.display = (form.style.display === "none") ? "block" : "none";
      }

      async function submitRefreshRequest(event) {
        event.preventDefault();
        // Show loading bar while we wait
        document.getElementById("loadSpinner").style.display = "block";

        rangeValue = document.getElementById("refeshScope").value;
        // Wait for response
        const response = await fetch(`/refreshDB?refreshScope=${rangeValue}`, {
          method: "GET"
        });
        // Stop waiting/loading
        document.getElementById("loadSpinner").style.display = "none";
      }

      function exportJSON() {
        const json = JSON.stringify(data.map(row => row), null, 2);
        downloadFile("data.json", json);
      }

      function exportCSV() {
        const csv = data.map(row => row).join(",\n");
        downloadFile("data.csv", csv);
      }

      function downloadFile(filename, content) {
        const blob = new Blob([content], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      function copyDonateTextClipBoard() {
        navigator.clipboard.writeText("0x81E11145Fc60Da6ebD43eee7c19e18Ce9e21Bfd5")
          .then(() => {
            // Show "Address copied" when succesful
            const infoText = document.createElement("div");
            infoText.className = "alert alert-success";
            infoText.style = "position: absolute; bottom: 10px; z-index: 100;";
            infoText.innerText = "Address copied!‚úÖ";

            // Append it to existing element
            document.getElementById("donateText").appendChild(infoText);

            // Remove info text after 1s
            setTimeout(() => {
              infoText.remove();
            }, 1000);
          });
      }

      function triggerAboutText() {
        const text = document.getElementById("aboutText");
        text.style.display = (text.style.display === "none") ? "block" : "none";
      }
    </script>
  </head>
  <body>
    <!-- Main web-page content container -->
    <div class="container-fluid">
        <!-- First row: Count chart + search bar + menu -->
        <div class="row">
            <!-- Clustered addresses count -->
            <div class="col position-relative">
                <!-- Faculty logo -->
                <div id="facLogo" class="position-absolute" style="margin-top: 1.5em; width: 60%; height: 20%; display: block;">
                  <img src="/static/VUTFIT_Logo.png" class="img-fluid">
                </div>

                <div id="resCharts" style="display: block; height: 150px; width: 250px;"></div>
                <div id="amountDiv" class="progress" style="display: none; width: 70%; margin-bottom: 1em;">
                    <div id="totalAmount" class="progress-bar" role="progressbar" aria-valuemin="0"></div>
                </div>
            </div>

            <!-- Search bar -->
            <div class="col-md-4 d-flex flex-column align-items-center">
                <h1 style="text-align: center; margin-top: 1em; margin-bottom: 1em;">
                    Ethereum Address Clustering
                </h1>

                <form class="d-flex" style="width: 100%;" action="/search" method="get">
                    <input class="form-control me-2" type="search" placeholder="Enter address" aria-label="Search" name="targetAddr" required pattern="^0X[0-9A-Fa-f]{40}$">
                    <button class="btn btn-primary" type="submit" style="white-space: nowrap;">Search üîé</button>
                </form>

                <!-- DB refresh spinner -->
                <div id="loadSpinner" class="spinner-border text-primary" role="status" style="display: none; margin-top: 1.5em;"></div>
            </div>

            <!-- Menu -->
            <div class="col">
                <div class="d-flex justify-content-end" style="margin-top: 1.5em;">
                    <button class="btn btn-primary" onclick="showMenu()"><i class="fa fa-bars"></i> Menu</button>
                </div>

                <div class="d-flex justify-content-end">
                    <form id="refreshForm" onsubmit="submitRefreshRequest(event)" style="display: none; width: 200px;">
                        <label id="refreshLabel" for="refeshScope" class="form-label">Refresh scope: 50 %</label>
                        <input type="range" class="form-range" min="1" max="100" step="1" id="refeshScope" onmousemove="showRangeValue(this)">
                        <button class="btn btn-danger" type="submit">Refresh Database</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Second row: Results table + graph -->
        <div class="row">
            <!-- Results table -->
            <div class="col-md-3">
                <div id="exports" style="display: none; gap: 5px;">
                    <button class="btn btn-primary" onclick="exportJSON()">Export to JSON</button>
                    <button class="btn btn-primary" onclick="exportCSV()">Export to CSV</button>
                </div>
                <div id="data_table"></div>
            </div>

            <!-- Results graph -->
            <div class="col" style="padding-right: 10px;">
                <div id="container" style="height: 100%;"></div>
            </div>
        </div>

        <!-- Page footer: "About" widget and donate text -->
        <div class="position-absolute bottom-0 start-0 mb-3 ms-3">
          <div id="aboutText" class="alert alert-primary" style="width: 300px; display: none;">
            Created as part of a bachelor thesis at Brno University of Technology by <b>Tom√°≈° Daniel</b>.
            Academic year 2024/25, supervised by Ing. Jan Zav≈ôel.
          </div>
          <button class="btn btn-warning" onclick="triggerAboutText()">About ‚ÑπÔ∏è</button>
        </div>

        <div id="donateText" class="d-flex justify-content-center position-absolute bottom-0 end-0 mb-4 ms-3">
          Feel free to donate: <span style="cursor: pointer;" onclick="copyDonateTextClipBoard()"><b>0x81E11145Fc60Da6ebD43eee7c19e18Ce9e21Bfd5</b></span>‚ù§Ô∏è
        </div>
    </div>

    {% if resultsList == "" %}
      <!-- Handle not found address -->
      <script type="text/javascript">
        // Keep faculty logo shown
        document.getElementById("facLogo").style.display = "block";
      </script>
    {% elif resultsList and resultsGraph %}
      <script type="text/javascript">
        // Hide faculty logo and show count charts instead
        document.getElementById("facLogo").style.display = "none";

        //*********** List of clustered addresses ***********//
        // Get data from Python
        var listData = {{ resultsList | safe }};

        // Create results table
        var table = new gridjs.Grid({
          columns: ["Entity"],
          data: listData.map(value => [value]),
          pagination: {
              limit: 20
          },
          resizable: true,
          search: true
        }).render(document.getElementById("data_table"));

        // Show export buttons
        document.getElementById("exports").style.display = "flex";

        // Render chart for count of clustered addresses
        var countChart = echarts.init(document.getElementById("resCharts"));
        countChart.setOption({
          series: [{
            name: "Address count",
            type: "gauge",
            progress: {
              show: true
            },
            axisLabel: { show: false }, axisTick: { show: false },
            detail: {
              valueAnimation: true
            },
            data: [{
              value: table.config.data.length
            }]
          }]
        });

        //*********** Render graph for results ***********//
        // Wrap chart creation into timeout to ensure hosting element is created before chart
        setTimeout(function () {
          var addrChart = echarts.init(dom=document.getElementById("container"), opts={
            renderer: "canvas"
          });

          // Get data from Python
          var graphData = {{ resultsGraph | safe }};
          // Create styling for each type of no`de
          let nodeStyles = {
            "exchange": 12,
            "deposit" : 10,
            "leaf"    : 8
          };

          let totalEtherAmount = 0;
          let graph = {
            nodes: graphData.nodes.map(node => ({
              ...node,
              symbolSize: nodeStyles[node.props.type],
              name      : node.id,
              value     : node.props,
              category  : node.props.type
            })),
            links: graphData.edges.map(edge => {
                // Collect sum of all transferred Ether for cluster
                totalEtherAmount += parseFloat(edge.props.amount);
                return {
                    source: edge.src,
                    target: edge.dst,
                    amount: edge.props.amount
                };
            }),
            categories: ["exchange", "deposit", "leaf"].map(function (category) {
              return {
                name: category
              };
            })
          };

          // Update bar showing total amount of Ether
          document.getElementById("amountDiv").style.display = "block";
          const item = document.getElementById("totalAmount");
          item.ariaValueNow = item.ariaValueMax = totalEtherAmount;
          item.textContent = "Total sent Ether by cluster: " + totalEtherAmount;

          addrChart.setOption({
            tooltip: {
                trigger: "item",
                formatter: function (params) {
                    if (params.dataType === "edge")
                        return `Ether amount: ${params.data.amount}`;
                }
            },
            legend: [{
              data: ["exchange", "deposit", "leaf"]
            }],
            series: [{
              type      : "graph",
              layout    : "force",
              data      : graph.nodes,
              links     : graph.links,
              categories: graph.categories,
              roam      : true,
              label: {
                position : "right"
              },
              force: {
                repulsion: 0,
                friction : 0,
                gravity  : 0
              },
              lineStyle: {
                color: "source"
              }
            }]
          });

          // Add listener for web-page resize events
          window.addEventListener("resize", addrChart.resize);
        }, 100);
      </script>
    {% endif %}
  </body>
</html>