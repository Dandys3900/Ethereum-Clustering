<!--
  @file base.html
  @author Tomáš Daniel (xdanie14)
  @brief Concrete for presented websites.
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Ethereum Address Clustering</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Bootstrap icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Favicon -->
    <link rel="icon" href="/static/graphics/favicon.ico" type="image/x-icon">
    <!-- Styles -->
    <link rel="stylesheet" href="/static/CSS/styles.css">

  </head>
  <body>
    <!-- Main content container -->
    <div class="container-fluid d-flex flex-column min-vh-100">
        <!-- First row: Count chart + search bar + menu -->
        <div class="row">
            {% block headerLeft %}{% endblock %}

            <!-- Search bar -->
            <div class="col-md-4 d-flex flex-column align-items-center">
                <h1 style="text-align: center; margin-top: 1em; margin-bottom: 1em;">
                Ethereum Address Clustering
                </h1>

                <form id="searchForm" class="d-flex" style="width: 100%; margin-bottom: 10px;" action="/search" method="post">
                    <input class="form-control me-2" type="search" placeholder="Enter Ethereum address" name="targetAddr" required pattern="^(0x|0X)[0-9A-Fa-f]{40}$" title="f.e. 0X0123456789abcdef9876543210ABCDEF00000000" value="{{ targetAddr }}">
                    <button class="btn btn-primary" type="submit" style="white-space: nowrap;">Search 🔎</button>
                </form>

                <!-- DB refresh spinner -->
                <div id="loadSpinner" class="spinner-border text-primary" role="status" style="display: none; margin-top: 1.5em; margin-bottom: 0.5em;"></div>
            </div>

            {% block headerRight %}{% endblock %}

            <!-- Menu -->
            <div class="col">
                <!-- Menu button -->
                <div class="d-flex justify-content-end gap-3" style="margin-top: 1.5em;">
                    <button id="takeMeHome" class="btn btn-warning" onclick="location.href='/'"><i class="fa fa-home"></i> Home</button>
                    <button class="btn btn-primary" onclick="triggerMenu()"><i class="fa fa-bars"></i> Menu</button>
                </div>

                <!-- Menu contents -->
                <div class="d-flex justify-content-end position-relative mt-2">
                    <div id="refreshForm" class="card p-2" style="display: none; width: 45%; position: absolute; z-index: 1000;">
                        {% set trezorUp = (clientData is not None) %}

                        <div>Blockchain client:</div>
                        {% if trezorUp %}
                            <span id="clientUpItems">
                                <b>Highest block: </b><span id="maxBlockItem">{{ clientData["maxBlock"] }}</span>
                                <b>Latest sync time: </b><span id="syncTimeItem">{{ clientData["syncTime"] }}</span>
                            </span>
                        {% else %}
                            <span id="clientDownItems">
                                <div style="color: red;">Client unavailable</div>
                            </span>
                        {% endif %}
                        <hr>

                        <div>Clustered addresses counts:</div>
                        <b>Exchanges: </b><span id="exchCountsItem">{{ addrsCount.exchanges }}</span>
                        <b>Deposits: </b><span id="deposCountsItem">{{ addrsCount.deposits }}</span>
                        <b>Leafs: </b><span id="leafsCountsItem">{{ addrsCount.leafs }}</span>
                        <hr>

                        <button type="button" class="btn btn-primary" onclick="showExchList()">Show used exchanges</button>
                        <hr>

                        <!-- If unable to parse clientData values, blockbook is probably down, avoid DB refresh-->
                        <button id="refreshDBbutton" type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmRefresh" {% if not trezorUp %} disabled {% endif %}>Refresh database</button>
                    </div>
                </div>
            </div>

            <!-- Dialog for DB refresh confirmation -->
            <div class="modal fade" id="confirmRefresh" role="dialog" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Database Refresh</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            Database update will start from cached block values. If custom block interval is selected below,
                            update will erase all currently stored values and will trigger complete re-clustering.
                            This action can take hours depending on selected scope.
                        </div>

                        <div class="modal-footer">
                            <form id="refreshModalForm">
                                <div class="d-flex gap-2">
                                    <label for="minBlockHeight" class="form-label"><b>Min:</b> </label>
                                    <input type="number" class="form-control" id="minBlockHeight" min="0" max="{{ clientData['maxBlock'] }}" value="{{ clientData['curBlockVals']['currentMinBlock'] }}">
                                    <label for="maxBlockHeight" class="form-label"><b>Max:</b> </label>
                                    <input type="number" class="form-control" id="maxBlockHeight" min="0" max="{{ clientData['curBlockVals']['currentMaxBlock'] }}" value="{{ clientData['maxBlock'] }}">
                                </div>

                                <label for="refeshScope" class="form-label">Refresh scope: <b id="refreshLabel">50 %</b></label>
                                {% set defCount = (exchLen / 2) | int %}
                                <label for="refeshScope" class="form-label">Number of addresses: <b id="exchLenLabel">{{ defCount }}</b></label>
                                <input type="range" class="form-range" min="1" max="100" step="1" value="50" id="refeshScope" onmousemove="showRangeValue({{ exchLen }}, this.value)">
                                <hr>

                                <div class="d-flex gap-1">
                                    <input type="password" maxlength="30" class="form-control me-2" id="refreshPwd" placeholder="Enter password" oninput="toggleProceedBtn(this.value)" required>
                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Abort</button>
                                    <button id="proceedBtn" type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="submitRefreshRequest(event)" disabled>Proceed</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dialog showing transactions for given edge or server's list of used exchanges -->
            <div class="modal fade" id="sharedModalID" role="dialog" tabindex="-1">
                <div class="modal-dialog" style="max-width: 70%; margin: auto;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="sharedModalTitle" class="modal-title"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div id="sharedModalBody" class="modal-body"></div>
                    </div>
                </div>
            </div>

            <!-- Dialog for editing selected exchange's list record -->
            <div class="modal fade" id="editExchAddrModal" role="dialog" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="sharedModalTitle" class="modal-title">Edit</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <input type="text" id="editModalAddr" class="form-control me-2" pattern="^(0x|0X)[0-9A-Fa-f]{40}$" required>
                            <input type="text" id="editModalAddrName" maxlength="32" class="form-control me-2" required>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="editExchAddr()" disabled>Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dialog for wrong entered password -->
            <div class="modal fade" id="errorText" role="dialog" tabindex="-1">
                <div class="modal-dialog alert alert-danger">
                    <div class="modal-content">
                        <div class="modal-body">
                            <strong id="alertText">Invalid password provided, try again please...</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second row: Results table + graph -->
        <div id="secondRow" class="row flex-nowrap flex-grow-1">
            {% block mainLeft %}{% endblock %}

            <div class="col-md">
                <div id="container" style="height: 100%;">
                    {% block mainCenter %}{% endblock %}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-2 mt-auto position-relative">
            <div class="container">
                <!-- About text and button -->
                <div id="aboutText" class="alert alert-primary position-absolute" style="width: 300px; display: none; z-index: 1000; bottom: 88%;">
                    Created as part of a bachelor thesis at Brno University of Technology by <b>Tomáš Daniel</b>.
                    Academic year 2024/25, supervised by Ing. Jan Zavřel.
                </div>

                <div class="row">
                    <!-- Top row -->
                    <div class="col d-flex justify-content-between">
                    <button class="btn btn-warning" onclick="triggerAboutText()">About ℹ️</button>

                    <!-- Donate text -->
                    <div id="donateText" class="text-md-end mt-2">
                        Feel free to donate some Ether:&nbsp;<span style="cursor: pointer;" onclick="copyDonateText()"><b>0x81E11145Fc60Da6ebD43eee7c19e18Ce9e21Bfd5</b></span>❤️
                    </div>
                    </div>
                </div>
                <hr>

                <!-- Bottom row - contacts -->
                <div class="row justify-content-center">
                    <div class="col-auto d-flex gap-3">
                    <a href="https://www.linkedin.com/in/tom%C3%A1%C5%A1-daniel-b71724197/" target="_blank">
                        <i class="bi bi-linkedin fs-4"></i>
                    </a>

                    <a href="https://github.com/Dandys3900/Ethereum-Clustering" target="_blank">
                        <i class="bi bi-github fs-4"></i>
                    </a>
                    </div>
                </div>
            </div>
        </footer>

        {% if ongoingRefresh %}
            <!-- Handle ongoing refresh -->
            <script type="text/javascript">
                // Hide content of second row
                hideElement("secondRow");
                // Disable all buttons
                document.querySelectorAll("button").forEach(button => button.disabled = true);
                // Show "Maintenance in progress" image
                showElement("refreshOn");
            </script>
        {% else %}
            <script type="text/javascript">
                // Show content of second row (if not already shown)
                if (document.getElementById("secondRow").style.display === "none")
                showElement("secondRow");
                // Re-enable all buttons
                document.querySelectorAll("button").forEach(button => button.enabled = true);
                // Hide "Maintenance in progress" image
                hideElement("refreshOn");
            </script>
        {% endif %}

        {% block graphCode %}{% endblock %}
    </div>

    <!-- Page functionality script -->
    <script src="/static/JS/script.js"></script>
  </body>
</html>
