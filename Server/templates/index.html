<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Ethereum Address Clustering</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <!-- GridJS -->
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

    <!-- JavaScript -->
    <script>
      function showRangeValue(rangeElement) {
        // Get current value of range and update label
        document.getElementById("refreshLabel").innerText = "Refresh scope: " + rangeElement.value + " %";
      }

      function showMenu() {
        const style = document.getElementById("refreshForm").style.display;
        if (style === "none")
            document.getElementById("refreshForm").style.display = "block";
        else
            document.getElementById("refreshForm").style.display = "none";
      }

      async function submitRefreshRequest(event) {
        event.preventDefault();
        // Show loading bar while we wait
        document.getElementById("loadSpinner").style.display = "block";

        rangeValue = document.getElementById("refeshScope").value;
        // Wait for response
        const response = await fetch(`/refreshDB?refreshScope=${rangeValue}`, {
          method: "GET"
        });
        // Stop waiting/loading
        document.getElementById("loadSpinner").style.display = "none";
      }
    </script>
  </head>
  <body>
    <!-- Main web-page content container -->
    <div class="container-fluid">
        <!-- First row: Count chart + search bar + menu -->
        <div class="row">
            <!-- Clustered addresses count -->
            <div class="col">
                <div id="res_charts" style="display: block; height: 150px; width: 250px;"></div>
            </div>

            <!-- Search bar -->
            <div class="col-md-4">
                <h1 style="text-align: center; margin-top: 1em; margin-bottom: 1em;">
                    Ethereum Address Clustering
                </h1>

                <form class="d-flex" action="/search" method="get">
                    <input class="form-control me-2" type="search" placeholder="Enter address" aria-label="Search" name="targetAddr" required pattern="^0X[0-9A-Fa-f]{40}$">
                    <button class="btn btn-primary" type="submit">Search</button>
                </form>
            </div>

            <!-- Menu -->
            <div class="col">
                <div class="d-flex justify-content-end" style="margin-top: 1.5em;">
                    <button class="btn btn-primary" onclick="showMenu()"><i class="fa fa-bars"></i> Menu</button>
                </div>

                <div class="d-flex justify-content-end">
                    <form id="refreshForm" onsubmit="submitRefreshRequest(event)" style="display: none; width: 200px;">
                        <label id="refreshLabel" for="refeshScope" class="form-label">Refresh scope: 50 %</label>
                        <input type="range" class="form-range" min="1" max="100" step="1" id="refeshScope" onmousemove="showRangeValue(this)">
                        <button class="btn btn-danger" type="submit">Refresh Database</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Second row: Results table + graph -->
        <div class="row">
            <!-- Results table -->
            <div class="col-md-3">
                <div id="exports" style="display: none; gap: 5px;">
                    <button class="btn btn-primary" onclick="exportJSON()">Export to JSON</button>
                    <button class="btn btn-primary" onclick="exportCSV()">Export to CSV</button>
                </div>
                <div id="data_table"></div>
            </div>

            <!-- Results graph -->
            <div class="col" style="padding-right: 10px;">
                <div id="container" style="height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- List of clustered addresses -->
    {% if resultsList %}
      <script type="text/javascript">
        // Get data from Python
        var data = {{ resultsList | safe }};

        // Create results table
        var table = new gridjs.Grid({
          columns: ["Entity"],
          data: data.map(value => [value]),
          pagination: {
              limit: 20
          },
          resizable: true,
          search: true
        }).render(document.getElementById("data_table"));

        function exportJSON() {
          const json = JSON.stringify(data.nodes.map(row => row.id), null, 2);
          downloadFile("data.json", json);
        }

        function exportCSV() {
          const csv = data.nodes.map(row => row.id).join(",\n");
          downloadFile("data.csv", csv);
        }

        function downloadFile(filename, content) {
          const blob = new Blob([content], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          link.click();
        }

        // Show export buttons
        document.getElementById("exports").style.display = "flex";

        // Render chart for count of clustered addresses
        var countChart = echarts.init(document.getElementById("res_charts"));
        countChart.setOption({
          series: [{
            name: "Address count",
            type: "gauge",
            progress: {
              show: true
            },
            axisLabel: { show: false }, axisTick: { show: false },
            detail: {
              valueAnimation: true
            },
            data: [{
              value: table.config.data.length
            }]
          }]
        });
      </script>
    {% endif %}

    <!-- Render graph for results -->
    {% if resultsGraph %}
      <script type="text/javascript">
        // Wrap chart crration into timeout to ensure hosting element is created before chart
        setTimeout(function () {
          var addrChart = echarts.init(dom=document.getElementById("container"), opts={
            renderer: "canvas"
          });

          // Get data from Python
          var data = {{ resultsGraph | safe }};
          // Create styling for each type of no`de
          let nodeStyles = {
            "exchange": 12,
            "deposit" : 10,
            "leaf"    : 8
          };

          let graph = {
            nodes: data.nodes.map(node => ({
              ...node,
              symbolSize: nodeStyles[node.props.type],
              name      : node.id,
              value     : node.props,
              category  : node.props.type
            })),
            links: data.edges.map(edge => ({
              source: edge.src,
              target: edge.dst
            })),
            categories: ["exchange", "deposit", "leaf"].map(function (category) {
              return {name: category};
            })
          };

          addrChart.setOption({
            legend: [{
              data: ["exchange", "deposit", "leaf"]
            }],
            series: [{
              type      : "graph",
              layout    : "force",
              data      : graph.nodes,
              links     : graph.links,
              categories: graph.categories,
              roam      : true,
              label: {
                position : "right",
                formatter: "{b}"
              },
              force: {
                repulsion: 0,
                friction : 0,
                gravity  : 0
              }
            }]
          });

          // Add listener for web-page resize events
          window.addEventListener("resize", addrChart.resize);
        }, 100);
      </script>
    {% endif %}
  </body>
</html>